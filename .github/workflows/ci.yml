name: CI

on:
  pull_request:
    branches: [main, beta]
  push:
    branches: [main, beta]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pnpm install
          pip install ruff sqlfluff

      - name: Get changed files
        id: get-files
        run: |
          echo "ğŸ” Detecting changed files..."

          # Get the correct base commit for comparison
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_COMMIT=${{ github.event.pull_request.base.sha }}
            echo "ğŸ“‹ PR detected - comparing against: $BASE_COMMIT"
          elif [ "${{ github.event_name }}" = "push" ]; then
            BASE_COMMIT=HEAD~1
            echo "ğŸ“‹ Push detected - comparing against: $BASE_COMMIT"
          else
            BASE_COMMIT=main
            echo "ğŸ“‹ Default - comparing against: $BASE_COMMIT"
          fi

          # Get changed files by type using git diff
          TS_FILES=$(git diff --name-only $BASE_COMMIT...HEAD -- '**/*.{ts,tsx}' | tr '\n' ' ' || true)
          JS_FILES=$(git diff --name-only $BASE_COMMIT...HEAD -- '**/*.{js,jsx}' | tr '\n' ' ' || true)
          PY_FILES=$(git diff --name-only $BASE_COMMIT...HEAD -- '**/*.py' | tr '\n' ' ' || true)
          SQL_FILES=$(git diff --name-only $BASE_COMMIT...HEAD -- '**/*.sql' | tr '\n' ' ' || true)

          # Debug output
          echo "ğŸ“ TypeScript files: ${TS_FILES:-none}"
          echo "ğŸ“ JavaScript files: ${JS_FILES:-none}"
          echo "ğŸ“ Python files: ${PY_FILES:-none}"
          echo "ğŸ“ SQL files: ${SQL_FILES:-none}"

          # Export for use in other steps
          echo "ts_files=$TS_FILES" >> $GITHUB_OUTPUT
          echo "js_files=$JS_FILES" >> $GITHUB_OUTPUT
          echo "py_files=$PY_FILES" >> $GITHUB_OUTPUT
          echo "sql_files=$SQL_FILES" >> $GITHUB_OUTPUT

          # Set flags for conditional steps
          [ -n "$TS_FILES" ] && echo "has_ts=true" >> $GITHUB_OUTPUT || echo "has_ts=false" >> $GITHUB_OUTPUT
          [ -n "$JS_FILES" ] && echo "has_js=true" >> $GITHUB_OUTPUT || echo "has_js=false" >> $GITHUB_OUTPUT
          [ -n "$PY_FILES" ] && echo "has_py=true" >> $GITHUB_OUTPUT || echo "has_py=false" >> $GITHUB_OUTPUT
          [ -n "$SQL_FILES" ] && echo "has_sql=true" >> $GITHUB_OUTPUT || echo "has_sql=false" >> $GITHUB_OUTPUT

      - name: Run ESLint on changed files
        if: steps.get-files.outputs.has_ts == 'true' || steps.get-files.outputs.has_js == 'true'
        run: |
          if [ -n "${{ steps.get-files.outputs.ts_files }}" ] || [ -n "${{ steps.get-files.outputs.js_files }}" ]; then
            echo "ğŸ§¹ Running ESLint on changed files..."
            echo "ğŸ“ Changed TS/TSX files: ${{ steps.get-files.outputs.ts_files }}"
            echo "ğŸ“ Changed JS/JSX files: ${{ steps.get-files.outputs.js_files }}"

            # Create a combined list of changed TS/JS files
            CHANGED_FILES="${{ steps.get-files.outputs.ts_files }} ${{ steps.get-files.outputs.js_files }}"
            echo "$CHANGED_FILES" | tr ' ' '\n' | xargs npx eslint --max-warnings 0
          else
            echo "âš ï¸  No specific TS/JS files detected, running full ESLint on web app..."
            npx eslint --max-warnings 0 --ext .ts,.tsx,.js,.jsx apps/web/src
          fi

      - name: Run TypeScript check on changed files
        if: steps.get-files.outputs.has_ts == 'true'
        run: |
          cd apps/web
          if [ -n "${{ steps.get-files.outputs.ts_files }}" ]; then
            echo "ğŸ”§ Running TypeScript check on changed files..."
            echo "ğŸ“ Changed TypeScript files: ${{ steps.get-files.outputs.ts_files }}"

            echo "${{ steps.get-files.outputs.ts_files }}" | tr ' ' '\n' | xargs ../../../node_modules/.bin/tsc --noEmit --project tsconfig.app.json
          else
            echo "âš ï¸  No specific TS files detected, running full TypeScript check..."
            ../../../node_modules/.bin/tsc --noEmit --project tsconfig.app.json
          fi

      - name: Run Python linting on changed files
        if: steps.get-files.outputs.has_py == 'true'
        run: |
          if [ -n "${{ steps.get-files.outputs.py_files }}" ]; then
            echo "ğŸ Running Python linting on changed files..."
            echo "ğŸ“ Changed Python files: ${{ steps.get-files.outputs.py_files }}"

            echo "${{ steps.get-files.outputs.py_files }}" | tr ' ' '\n' | xargs ruff check --max-warnings=0
          else
            echo "âœ… No Python files changed - skipping Python linting"
          fi

      - name: Run SQL linting on changed files
        if: steps.get-files.outputs.has_sql == 'true'
        run: |
          if [ -n "${{ steps.get-files.outputs.sql_files }}" ]; then
            echo "ğŸ—„ï¸ Running SQL linting on changed files..."
            echo "ğŸ“ Changed SQL files: ${{ steps.get-files.outputs.sql_files }}"

            echo "${{ steps.get-files.outputs.sql_files }}" | tr ' ' '\n' | xargs sqlfluff fix --dialect postgres
          else
            echo "âœ… No SQL files changed - skipping SQL linting"
          fi

      - name: Code quality summary
        if: always()
        run: |
          echo "ğŸ¯ Code Quality Check Summary:"
          echo "ğŸ“Š TypeScript files processed: ${{ steps.get-files.outputs.has_ts == 'true' && 'Yes' || 'No' }}"
          echo "ğŸ§¹ JavaScript files processed: ${{ steps.get-files.outputs.has_js == 'true' && 'Yes' || 'No' }}"
          echo "ğŸ Python files processed: ${{ steps.get-files.outputs.has_py == 'true' && 'Yes' || 'No' }}"
          echo "ğŸ—„ï¸ SQL files processed: ${{ steps.get-files.outputs.has_sql == 'true' && 'Yes' || 'No' }}"
          echo ""
          echo "ğŸ“ Files processed:"
          echo "  TS/TSX: ${{ steps.get-files.outputs.ts_files }}"
          echo "  JS/JSX: ${{ steps.get-files.outputs.js_files }}"
          echo "  Python: ${{ steps.get-files.outputs.py_files }}"
          echo "  SQL: ${{ steps.get-files.outputs.sql_files }}"
          echo ""
          echo "âœ… All code quality checks completed successfully!"

      - name: Run build
        run: pnpm build
