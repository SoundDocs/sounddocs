name: CI

on:
  pull_request:
    branches: [main, beta]
  push:
    branches: [main, beta]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pnpm install
          pip install ruff sqlfluff

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*.{ts,tsx}
            **/*.{js,jsx}
            **/*.py
            **/*.sql

      - name: Run ESLint on changed files
        if: steps.changed-files.outputs.any_changed == 'true' && (steps.changed-files.outputs.ts_any_changed == 'true' || steps.changed-files.outputs.js_any_changed == 'true')
        run: |
          echo "ğŸ§¹ Running ESLint on changed files..."
          echo "ğŸ“ Changed TS/TSX files: ${{ steps.changed-files.outputs.ts }}"
          echo "ğŸ“ Changed JS/JSX files: ${{ steps.changed-files.outputs.js }}"

          # Create a combined list of changed TS/JS files
          CHANGED_FILES="${{ steps.changed-files.outputs.ts }} ${{ steps.changed-files.outputs.js }}"

          if [ -n "$CHANGED_FILES" ]; then
            echo "$CHANGED_FILES" | tr ' ' '\n' | xargs npx eslint --max-warnings 0
          fi

      - name: Run TypeScript check on changed files
        if: steps.changed-files.outputs.ts_any_changed == 'true'
        run: |
          echo "ğŸ”§ Running TypeScript check on changed files..."
          echo "ğŸ“ Changed TypeScript files: ${{ steps.changed-files.outputs.ts }}"

          cd apps/web
          echo "${{ steps.changed-files.outputs.ts }}" | tr ' ' '\n' | xargs npx tsc --noEmit --project tsconfig.app.json

      - name: Run Python linting on changed files
        if: steps.changed-files.outputs.py_any_changed == 'true'
        run: |
          echo "ğŸ Running Python linting on changed files..."
          echo "ğŸ“ Changed Python files: ${{ steps.changed-files.outputs.py }}"

          echo "${{ steps.changed-files.outputs.py }}" | tr ' ' '\n' | xargs ruff check --max-warnings=0

      - name: Run SQL linting on changed files
        if: steps.changed-files.outputs.sql_any_changed == 'true'
        run: |
          echo "ğŸ—„ï¸ Running SQL linting on changed files..."
          echo "ğŸ“ Changed SQL files: ${{ steps.changed-files.outputs.sql }}"

          echo "${{ steps.changed-files.outputs.sql }}" | tr ' ' '\n' | xargs sqlfluff fix --dialect postgres

      - name: Code quality summary
        if: always()
        run: |
          echo "ğŸ¯ Code Quality Check Summary:"
          echo "ğŸ“Š Total changed files: ${{ steps.changed-files.outputs.any_changed }}"
          echo "ğŸ”§ TypeScript files checked: ${{ steps.changed-files.outputs.ts_any_changed }}"
          echo "ğŸ§¹ JavaScript files linted: ${{ steps.changed-files.outputs.js_any_changed }}"
          echo "ğŸ Python files linted: ${{ steps.changed-files.outputs.py_any_changed }}"
          echo "ğŸ—„ï¸ SQL files linted: ${{ steps.changed-files.outputs.sql_any_changed }}"
          echo "âœ… All code quality checks completed successfully!"

      - name: Run build
        run: pnpm build
